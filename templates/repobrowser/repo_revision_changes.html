<html>
    <head>
		<link rel="stylesheet" href="{{STATIC_URL}}common/css/bootstrap.css" type="text/css" media="screen"/>
		<link rel="stylesheet" href="{{STATIC_URL}}common/css/bootstrap-responsive.css" type="text/css" media="screen"/>
		<link rel="stylesheet" href="{{STATIC_URL}}common/css/yacrt-site.css" type="text/css" media="screen"/>
	</head>
	<body>

		<div style="margin-left:1000px; margin-top: 30px; font-size: 14px">
			Welcome {{user_name}}
			<br>
			<a href="/registration/signout/">Logout</a>
		</div>
		<div style="width: 100%; height: 100%; margin-top: 30px;">
			<h2>Changes for revision {{rev_number}} of {{repo_name}}</h2>
			{%for p in changed_paths%}
			<br>
            <div class="auto-hide-scroll">
            <div style="width: 2000px;">
			<table class="diff-table">
				<colgroup width="2%"></colgroup>
				<colgroup width="2%"></colgroup>
				<colgroup width="96%"></colgroup>
				<tbody>
					<tr>
						<td class="change-title" colspan=3 style="font-size:20px"><b class="{{p.change.get_action_on_file}}">{{p.change.get_action_on_file}}</b><b>&nbsp;&nbsp;{{p.change.get_relative_path}}</b> &nbsp;&nbsp; <a href="javascript:void(0);" onclick=expand_view(this,"diff-view-{{forloop.counter}}")> <i class="icon-minus"></i> </a></td>
					</tr>
					<tbody id="diff-view-{{forloop.counter}}">
					{%for line in p.diff%}
					{%autoescape off%} {{line}} {% endautoescape%}
					<tr id="comments-row" style="display: none">
						<td colspan="2" id="comments-count line-number"></td>
						<td id="comments-holder">
                            <div id="all-comments" style="display: none"></div>
                            <input type="button" class="btn" id="add-new-comment-button" style="display:none;" 
                                value="Add Comment" onclick="comment_new_action(this)"/>
						</td>
					</tr>
					{%endfor%}
					</tbody>
				</tbody>
			</table>
            </div>
            </div>
			<br>
			{%endfor%}
        </div>
        
        <div id="comment-form" style="display:none;">
            <textarea id="comment-content" rows="3" style="width: 100%" placeholder="Leave a comment for this line"></textarea>
            <input type="button" class="btn" id="comment-action-button" value=""
                onclick="comment_form_action(this)"/>
            <input type="button" class="btn" id="comment-close-button" value="Close Form"
                onclick="comment_close_action(this)"/>
        </div>

		<script type="text/javascript" src="{{STATIC_URL}}common/js/jquery.js"></script>
        <script type="text/javascript">
            function render_comment_template(content, author) {
		        var  comment= "<div class='comment'> <div class='comment-author-timestamp'>"+author+" commented at "+ Date().toLocaleString()+" </div><div class='comment-content'>"+content+"</div></div>";
                return comment;
	        }

            //handler invoked when Add Comment button is pressed
            function comment_new_action(e) {
                create_comment_form($(e).parent(), "Add Comment");
                $(e).hide();
            }

            //handler invoked when comment form button is pressed
            function comment_form_action(e) {
                comment_box = $(e).prev()[0];
                comment_content = comment_box.value;
                comment_content = comment_content.trim();
                all_comments = $(e).parent().parent().children("#all-comments");
                if(comment_content && comment_content != "") {
                    //append comment
                    $(all_comments).append(render_comment_template(comment_content, "Author"));
                    //show all comments div if reqd
                    if(!$(all_comments).is(":visible")) {
                        $(all_comments).show();
                    }
                }
                comment_box.value = "";
            }

            function update_comment_row_visibility(e) {
                if (!($(e).children("#all-comments").is(":visible"))) {
                    $(e).parent().hide();
                }
            }

	   //Close Form button functionality
	    function comment_close_action(e) {
                update_comment_row_visibility($(e).parent().parent());
                $(e).parent().prev().show();
                if($(e).prev().attr('value') == "Add Comment") {
                    $(e).parent().remove();
                }
            }

            //Creates a form and appends it as child of e
            function create_comment_form(e, action_label) {                
                comment_form = $('#comment-form').clone();
                comment_form_elements = $(comment_form).children();
                comment_form_elements[1].value = action_label;
                $(comment_form).show();
                $(e).append($(comment_form));
                $(comment_form).prev().hide();
            }

            //handler invoked when diff output row is clicked
            function comment_action() {
                e = $(this).next('tr')
                if(!($(e).is(":visible"))) {
                    $(e).show();
                    create_comment_form($(e).children('#comments-holder'), "Add Comment");
                }
            }

            //adds on click handler to each of the diff output rows
			$(function() {
				els = $(this).find('tbody');
				els.each(function(){
					id = $(this).attr('id');
					if(id && id.indexOf('diff-view')>=0) {
						$(this).children('tr').each(function(){
							if(!$(this).attr('id') || $(this).attr('id').indexOf('comments-row') <0) {
								$(this).click(comment_action);
							} 
						});
					}
				});
			})

            //Expand and collapse the diff output
            function expand_view(src_elem, elem_id) {
                if ($(src_elem).children().attr('class') == "icon-plus") {
                    $(src_elem).children().attr('class', 'icon-minus');
                } else {
                    $(src_elem).children().attr('class', 'icon-plus');
                }
                $('#' + elem_id).slideToggle(100);
            }
		</script>
	</body>
</html>
